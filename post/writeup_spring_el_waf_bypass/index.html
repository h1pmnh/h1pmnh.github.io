<!doctype html><html lang=en data-figures=true class=page><head><title>Bug Writeup: RCE via SSTI on Spring Boot Error Page with Akamai WAF Bypass | A developer's notes in the world of security research and bug bounty, by pmnh</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv=x-ua-compatible content="IE=edge"><script async src="https://www.googletagmanager.com/gtag/js?id=G-0MD8T00339"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0MD8T00339")</script><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta name=description content="Writeup of a collaborated bug on Bugcrowd where I was able to bypass Akamai WAF to exploit RCE on Spring Boot error page using SpEL"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@pmnh_"><meta name=twitter:title content="Bug Writeup: RCE via SSTI on Spring Boot Error Page with Akamai WAF Bypass"><meta property="og:url" content="https://www.pmnh.site/post/writeup_spring_el_waf_bypass/"><meta property="og:title" content="Bug Writeup: RCE via SSTI on Spring Boot Error Page with Akamai WAF Bypass"><meta property="og:description" content="Writeup of a collaborated bug on Bugcrowd where I was able to bypass Akamai WAF to exploit RCE on Spring Boot error page using SpEL"><meta property="og:image" content="https://www.pmnh.site/images/thumbnail.png"><link rel=apple-touch-icon sizes=180x180 href=https://www.pmnh.site/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.pmnh.site/icons/favicon-32x32.png><link rel=manifest href=https://www.pmnh.site/icons/site.webmanifest><link rel=canonical href=https://www.pmnh.site/post/writeup_spring_el_waf_bypass/><link rel=preload href=https://www.pmnh.site/css/styles.d2341e528eb3fc44518edc1443c1c1fbe5b07c1e0be497aac9215471cbd67c22f81659723492fb0dfabf1d35b350a832b5e3a995b839fddd1c9e47211f338d28.css integrity="sha512-0jQeUo6z/ERRjtwUQ8HB++WwfB4L5JeqySFUccvWfCL4FllyNJL7Dfq/HTWzUKgyteOplbg5/d0cnkchHzONKA==" as=style crossorigin=anonymous><link rel=preload href=https://www.pmnh.site/en/js/bundle.19668860ea177cfe8cad686c7464b57e39acde1a4c33f6a1a8c57f7ab127ac39e8330b38e7184422cf0e9351ef3efaf75d122eca818d38a929941b8a5c04b09e.js as=script integrity="sha512-GWaIYOoXfP6MrWhsdGS1fjms3hpMM/ahqMV/erEnrDnoMws45xhEIs8Ok1HvPvr3XRIuyoGNOKkplBuKXASwng==" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://www.pmnh.site/css/styles.d2341e528eb3fc44518edc1443c1c1fbe5b07c1e0be497aac9215471cbd67c22f81659723492fb0dfabf1d35b350a832b5e3a995b839fddd1c9e47211f338d28.css integrity="sha512-0jQeUo6z/ERRjtwUQ8HB++WwfB4L5JeqySFUccvWfCL4FllyNJL7Dfq/HTWzUKgyteOplbg5/d0cnkchHzONKA==" crossorigin=anonymous></head><body data-code=10 data-lines=false id=documentTop><header class=nav_header><nav class=nav><a href=https://www.pmnh.site/ class="nav_brand nav_item" title="A developer's notes in the world of security research and bug bounty, by pmnh">A developer's notes in the world of security research and bug bounty, by pmnh<div class=nav_close><div><svg class="icon"><title>open-menu</title><use xlink:href="#open-menu"/></svg><svg class="icon"><title>closeme</title><use xlink:href="#closeme"/></svg></div></div></a><div class='nav_body nav_body_left'><div class=nav_parent><a href=https://www.pmnh.site/ class=nav_item title=Home>Home</a></div><div class=nav_parent><a href=https://www.pmnh.site/about/ class=nav_item title=About>About</a></div><div class=follow><a href=https://github.com/h1pmnh><svg class="icon"><title>github</title><use xlink:href="#github"/></svg></a><a href=https://twitter.com/pmnh_><svg class="icon"><title>twitter</title><use xlink:href="#twitter"/></svg></a><a href=https://www.pmnh.site/index.xml><svg class="icon"><title>rss</title><use xlink:href="#rss"/></svg></a><div class=color_mode><input type=checkbox class=color_choice id=mode></div></div></div></nav></header><main><div class="grid-inverse wrap content"><article class=post_content><h1 class=post_title>Bug Writeup: RCE via SSTI on Spring Boot Error Page with Akamai WAF Bypass</h1><div class=post_meta><span><svg class="icon"><title>calendar</title><use xlink:href="#calendar"/></svg></span><span class=post_date>Dec 4, 2022</span>
<span class=post_time>Â· 10 min read</span><span>&nbsp;Â· <a href=https://www.pmnh.site/tags/writeup title=writeup class="post_tag button button_translucent">writeup
</a><a href=https://www.pmnh.site/tags/rce title=rce class="post_tag button button_translucent">rce
</a><a href=https://www.pmnh.site/tags/bugcrowd title=bugcrowd class="post_tag button button_translucent">bugcrowd
</a><a href=https://www.pmnh.site/tags/waf title=waf class="post_tag button button_translucent">waf</a></span>
<span class=page_only>&nbsp;Â·<div class=post_share>Share on:
<a href="https://twitter.com/intent/tweet?text=Bug%20Writeup%3a%20RCE%20via%20SSTI%20on%20Spring%20Boot%20Error%20Page%20with%20Akamai%20WAF%20Bypass&url=https%3a%2f%2fwww.pmnh.site%2fpost%2fwriteup_spring_el_waf_bypass%2f&tw_p=tweetbutton" class=twitter title="Share on Twitter" target=_blank rel=nofollow><svg class="icon"><title>twitter</title><use xlink:href="#twitter"/></svg></a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.pmnh.site%2fpost%2fwriteup_spring_el_waf_bypass%2f&t=Bug%20Writeup%3a%20RCE%20via%20SSTI%20on%20Spring%20Boot%20Error%20Page%20with%20Akamai%20WAF%20Bypass" class=facebook title="Share on Facebook" target=_blank rel=nofollow><svg class="icon"><title>facebook</title><use xlink:href="#facebook"/></svg></a><a href=#linkedinshare id=linkedinshare class=linkedin title="Share on LinkedIn" rel=nofollow><svg class="icon"><title>linkedin</title><use xlink:href="#linkedin"/></svg></a><a href=https://www.pmnh.site/post/writeup_spring_el_waf_bypass/ title="Copy Link" class="link link_yank"><svg class="icon"><title>copy</title><use xlink:href="#copy"/></svg></a></div></span></div><div class=post_toc><h2>Overview</h2><nav id=TableOfContents><ul><li><a href=#summary>Summary</a></li><li><a href=#intro>Intro</a></li><li><a href=#steps-with-rce-via-spel>Steps with RCE via SpEL</a></li><li><a href=#a-quick-note---time--effort-spent>A Quick Note - Time / Effort Spent</a></li><li><a href=#step-1---try-the-obvious>Step 1 - Try the Obvious</a></li><li><a href=#step-2---figure-out-how-to-get-an-arbitrary-class>Step 2 - Figure out how to get an arbitrary Class</a></li><li><a href=#step-3---figure-out-how-to-get-an-arbitrary-string>Step 3 - Figure out how to get an arbitrary String</a></li><li><a href=#step-4---figure-out-how-to-get-a-reference-to-a-javalangcharacter-class>Step 4 - Figure out how to get a reference to a <code>java.lang.Character</code> class</a></li><li><a href=#step-5---build-attack-payload>Step 5 - Build attack payload</a></li><li><a href=#step-6---time-wasted-trying-to-work-around-get-length-restrictions>Step 6 - (Time Wasted) Trying to work around <code>GET</code> length restrictions</a></li><li><a href=#step-7---assembling-the-final-payload>Step 7 - Assembling the final payload</a></li><li><a href=#final-thoughts>Final Thoughts</a></li></ul></nav></div><div class=post_body><h2 id=summary>Summary</h2><p>This writeup talks about a successful collab that I did with <a href=https://bugcrowd.com/Dark9T>Dark9T</a> (<a href=https://twitter.com/UsmanMansha420>@UsmanMansha</a>) on a private program hosted on Bugcrowd. We ended up able to bypass Akamai WAF and achieve Remote Code Execution (P1) using Spring Expression Language injection on an application running Spring Boot. This was the 2nd RCE via SSTI we found on this program, after the 1st one, the program implemented a WAF which we were able to bypass in a different part of the application. Read on to find out how we did it!</p><p><figure><picture><img class="image_figure image_internal" src=https://www.pmnh.site/images/2022-writeup-spring-el-waf/resolved_bug_screenshot.png alt="Screenshot of Resolved Bug" loading=lazy decoding=async width=668 height=217></picture></figure></p><h2 id=intro>Intro</h2><p>Usman reached out to me on a Slack server where we are both members. They had found a potential SSTI but were not able to exploit it due to an Akamai WAF:</p><p><figure><picture><img class="image_figure image_internal" src=https://www.pmnh.site/images/2022-writeup-spring-el-waf/slack_message.png alt="Screenshot of Slack Message" loading=lazy decoding=async width=813 height=192></picture></figure></p><p>After a quick look, this seemed to be a case of the famous Spring Boot Error page issue <a href=https://github.com/spring-projects/spring-boot/issues/4763>described on Github here</a> - note that there was never a CVE issued for this as far as I am aware. This vulnerability has been covered in various forms for example by <em>0xdeadpoool</em> on their blog <a href=https://f002.backblazeb2.com/file/sec-news-backup/files/writeup/deadpool.sh/_2017_RCE_Springs_/index.html>here</a>.</p><p>The basic principle of this bug is that the vulnerable version of Spring Boot will render the error message from the thrown <code>Exception</code> into the page itself using an SpEL (Spring Expression Language) expression. The vulnerable version of the Spring Boot framework will allow recursive evaluation of this expression, thus an error message which contains a valid SpEL expression (e.g. <code>$(7*7)</code>) would be evaluated at the the time the error page is rendered.</p><p>In this case we could see the <code>q</code> parameter of the vulnerable URL supported injection of the type <code>${x*y}</code> and returned a mathematical result in the error text:</p><p><figure><picture><img class="image_figure image_internal" src=https://www.pmnh.site/images/2022-writeup-spring-el-waf/spel_expression_simple.png alt="Screenshot of Initial SpEL test" loading=lazy decoding=async width=2560 height=921></picture></figure></p><h2 id=steps-with-rce-via-spel>Steps with RCE via SpEL</h2><p>If you haven't had experience with this type of vulnerable application before, I'd strongly suggest some practice using an application such as <a href=https://github.com/jzheaux/spel-injection>https://github.com/jzheaux/spel-injection</a> where you can experiment with how SpEL is constructed and handled (and potentially secured) within Spring applications. While this application doesn't deal directly with this specific vulnerability, SpEL is used so often in the Spring Ecosystem it's worth some practice and familiarity with the code.</p><p>This blog won't introduce you to Spring Expression Language as the topic is quite complex, essentially it's a language which allows context-based navigation of Spring objects, similar to other server-side templating languages. It's used many places in various Spring Framework components and the exact extent of objects and data available depends a lot on where it's used. Typically you can execute Java methods, construct objects, etc. - not as powerfully as FreeMarker or Velocity, but similar in risk profile. You can read about SpEL and its syntax <a href=https://docs.spring.io/spring-framework/docs/3.0.x/reference/expressions.html>in the Spring reference documentation</a>.</p><p>Generally the goal with SpEL is to end up with an invocation of the methods <code>java.lang.Runtime.exec</code> or <code>java.lang.ProcessBuilder.start</code> which will allow execution of an OS command of the attacker's choosing, using an expression something like the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln>1</span><span class=cl><span class=n>$</span><span class=o>{</span><span class=n>T</span><span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Runtime</span><span class=o>).</span><span class=na>getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=s>&#34;&lt;my command here&gt;&#34;</span><span class=o>)}</span>
</span></span></code></pre></div><p>If you want the output of the command, the expression gets a bit more complex, but let's start here.</p><h2 id=a-quick-note---time--effort-spent>A Quick Note - Time / Effort Spent</h2><p>Folks who know me know that I am primarily a manual tester, relying on my extensive development/architecture experience rather than brute force to find tough bugs. Although reading a blog post may make it appear that a bug was obvious or a particular path was obvious, just to give some statistics, getting from the initial Slack message from Usman to full RCE took me:</p><ul><li>Approximately 500 hand-crafted attempts to bypass the WAF</li><li>Approximately 14 hours of <em>wall clock time</em> from the initial attempt to the first successful RCE (execution of the <code>uname -a</code> command) - note that I took breaks to eat, take a walk, think about solutions etc. - it wasn't 14 hours straight!</li></ul><p>I'm including these because it's often the case that blog posts make this kind of bug "seem" a lot easier than it actually is, leading readers down the dark path of impostor syndrome etc., just reinforcing that even if you know what you're doing, sometimes bugs are really tough! Don't give up! ðŸ˜„</p><h2 id=step-1---try-the-obvious>Step 1 - Try the Obvious</h2><p>First off we had to determine how to reach the <code>java.lang.Runtime</code> class, so that we could get an instance of it, on which to invoke the <code>exec</code> method. We tried the most obvious <code>${T(java.lang.Runtime)}</code> - which is SpEL shorthand for referencing a Java class by name, and of course it was blocked by the Akamai WAF:</p><p><figure><picture><img class="image_figure image_internal" src=https://www.pmnh.site/images/2022-writeup-spring-el-waf/t_operator_waf_block.png alt="First Attempt" loading=lazy decoding=async width=2556 height=565></picture></figure></p><p>Since Akamai WAF was in the way, I suspected this would not work, but when trying to work around a WAF it's really important to build up from small things that you know work, to larger and more complex payloads. This is true for RCE, SQLi, XSS, or any complex payload when trying to avoid WAF rules, very often WAFs are coded to recognize obvious payloads but (as we will see) can't figure out complex payloads.</p><h2 id=step-2---figure-out-how-to-get-an-arbitrary-class>Step 2 - Figure out how to get an arbitrary Class</h2><p>Typically the next stage of a Java-based code injection vulnerability is to figure out how to get a reference to an arbitrary <code>Class</code>, from which we can use direct method invocation or reflection-based invocation to get at the method we want.</p><p>The easiest method is to do something like the following (which worked in this case):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln>1</span><span class=cl><span class=n>$</span><span class=o>{</span><span class=mf>2.</span><span class=n>class</span><span class=o>}</span>
</span></span></code></pre></div><p>Response:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=ln>1</span><span class=cl>class java.lang.Integer
</span></span></code></pre></div><p>This is a good sign, we know we can access the <code>java.lang.Integer</code> <code>Class</code> object (if you need a refresher [https://stackoverflow.com/questions/1215881/the-difference-between-classes-objects-and-instances](this SO answer is a good start)), and from here we should be able to get to the <code>forName</code> method to instantiate an arbitrary class. Let's try it!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln>1</span><span class=cl><span class=n>$</span><span class=o>{</span><span class=mf>2.</span><span class=n>class</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=s>&#34;java.lang.String&#34;</span><span class=o>)}</span>
</span></span></code></pre></div><p>Response:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=ln>1</span><span class=cl><span class=p>&lt;</span><span class=nt>H1</span><span class=p>&gt;</span>Access Denied<span class=p>&lt;/</span><span class=nt>H1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>2</span><span class=cl> 
</span></span><span class=line><span class=ln>3</span><span class=cl>You don&#39;t have permission to access ...
</span></span></code></pre></div><p>As expected, the obvious payload using the <code>forName</code> method with a string did not work and was easily detected by the Akamai WAF. In the next round of exploration I was able to determine that some sort of transformation was being applied to both single and double quotes that caused expressions using either of these characters to be malformed. Thus even if we could reach the <code>Class.forName</code> method, we wouldn't be able to take the straightforward route of something like <code>${2.class.forName("java.lang.Runtime")...}</code> but instead need to find some other way to construct the name of the Class to be instantiated.</p><h2 id=step-3---figure-out-how-to-get-an-arbitrary-string>Step 3 - Figure out how to get an arbitrary String</h2><p>I knew that being able to build an arbitrary string would be required to achieve the full RCE for multiple reasons:</p><ul><li>Name of class to be instantiated or referenced</li><li>Name of method (most likely <code>.exec()</code> is also blocked by the WAF)</li><li>Command to be executed</li></ul><p>Keep in mind that I can't use quote characters of either type, so straightforward string concatenation is not possible in this circumstance. I needed to find a way to get from an integer value (ASCII or hex) to a character, and then concatenate characters to form a <code>String</code>.</p><blockquote><p>I've run into this situation a number of times, either solo or in collabs and I always refer back to the <a href=https://docs.oracle.com/javase/8/docs/api/>Java API Documentation</a> which has so much useful information about available methods and classes, although I know many of the core Java classes by heart, it's often been the case that I find some hidden gem that will do exactly what I need!</p></blockquote><p>A few obvious choices in the Java standard library:</p><ul><li><code>java.lang.String</code> constructor, taking a byte array (as inspired by <a href=https://mkyong.com/java/how-do-convert-byte-array-to-string-in-java/>mykong</a> and <a href=https://www.baeldung.com/java-string-to-byte-array>Bealdung</a>)</li><li><code>java.lang.Character.toString</code> method, described in <a href=https://docs.oracle.com/javase/8/docs/api/java/lang/Character.html#toString-char->Javadoc</a></li></ul><p>After some experimentation I determined that it was basically not possible to invoke any constructor, because both methods of invoking a constructor in SpEL, either <code>new</code>, <code>T()</code>, or through reflection and <code>newInstance</code> was also blocked by the WAF.</p><p>So it seemed like the <code>java.lang.Character.toString</code> method was the way to go, only one problem...</p><h2 id=step-4---figure-out-how-to-get-a-reference-to-a-javalangcharacter-class>Step 4 - Figure out how to get a reference to a <code>java.lang.Character</code> class</h2><p>Since <code>java.lang.Character.toString</code> is a static method on the <code>java.lang.Character</code> class, I simply needed a reference to an object of this type to be able to reach the method. Because SpEL is dynamic, I don't believe it supports casting as you could in static Java code, e.g. <code>(char)99</code> - and unfortunately <code>java.lang.Class</code> was blocked by the WAF so I couldn't use the <code>java.lang.Class.cast</code> method.</p><p>So I ended up with the following chain:</p><ul><li>Figure out how to get a reference to a <code>String</code> object</li><li>Call the <code>java.lang.String.charAt</code> method on that object (which returns a <code>java.lang.Character</code>)</li><li>Invoke the <code>toString</code> static method on this character - since it's a static method it doesn't matter what the value of the <code>Character</code> is</li></ul><p>Thus I <em>finally</em> had my gadget required to build an arbitrary <code>String</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln>1</span><span class=cl><span class=n>$</span><span class=o>{(</span><span class=mf>2.</span><span class=n>toString</span><span class=o>()+</span><span class=mi>2</span><span class=o>).</span><span class=na>charAt</span><span class=o>(</span><span class=mi>0</span><span class=o>).</span><span class=na>class</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=mi>99</span><span class=o>)}</span>
</span></span></code></pre></div><p>Response</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=ln>1</span><span class=cl>c
</span></span></code></pre></div><p>Note that <code>99</code> is the ASCII value for the character <code>c</code>. Success!</p><p>Since the <code>+</code> character was allowed through the WAF and in this context I was able to now build strings using this method of individual character concatenation.</p><h2 id=step-5---build-attack-payload>Step 5 - Build attack payload</h2><p>So, now we have one ingredient we need - building arbitrary <code>String</code> - we need one more, which is a way to invoke the <code>java.lang.Runtime.exec</code> method. I ended up using a technique similar to the one <a href=https://pulsesecurity.co.nz/articles/EL-Injection-WAF-Bypass>described here</a>, basically the following:</p><ul><li>Use reflection to get access to the <code>Class.forName</code> method</li><li>Build a String with the value <code>java.lang.Runtime</code> to pass to <code>forName</code></li><li>Use reflection to get access to the <code>java.lang.Runtime.getRuntime</code> method (required to get an instance of the class to invoke a method)</li><li>Build a String with the value <code>exec</code> and/or use reflection to find the <code>exec</code> method of the <code>java.lang.Runtime</code> class</li><li>Build a String with the RCE payload value to pass to the <code>exec</code> method</li></ul><p>In this phase of the exploitation, I spent a lot of time iterating over the output from various reflection calls. This is especially important because different JVMs will return different values, particularly when you are using the <code>java.lang.Class.getMethods</code> reflection technique.</p><blockquote><p>Don't invoke reflected methods blindly! There are dangerous methods on <code>java.lang.Runtime</code> such as <code>shutdown</code> which will immediately terminate the JVM!</p></blockquote><h2 id=step-6---time-wasted-trying-to-work-around-get-length-restrictions>Step 6 - (Time Wasted) Trying to work around <code>GET</code> length restrictions</h2><p>At this point I realized that for some payloads I would end up with a really long payload if I'm constructing a long RCE command e.g. an <code>nslookup</code> or similar. My payload for a single character <code>c</code> was 45 bytes long (<code>${(2.toString()+2).charAt(0).class.toString(99)}</code>)!</p><p>With a <code>GET</code> request maximum length enforced by some browsers and/or servers at approximately ~2kb this meant the longest <code>String</code> I could build might be only about 45 characters long - a big problem!</p><p>At this point I ended up going down a bit of a chase to figure out how to more efficiently create a <code>String</code> from a list of bytes. I tried a bunch of things and almost had one working using the neat <a href=https://docs.spring.io/spring-framework/docs/3.0.x/reference/expressions.html#d0e12113>collection projection</a> feature of SpEL, but unfortunately I was blocked by a Spring bug in the version this target was running. Ultimately I couldn't find any more efficient method of building the <code>String</code> character by character.</p><p>In this sense I ended up getting lucky, the server accepted a <code>GET</code> request longer than 2kb (final payload was just under 3kb), and typically you are safe before 4kb on most servers.</p><h2 id=step-7---assembling-the-final-payload>Step 7 - Assembling the final payload</h2><p>At this point after Step 5 I basically had all the pieces I needed to build the final payload, which was essentially a translation of the following payload:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=ln>1</span><span class=cl><span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>commons</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOUtils</span><span class=o>.</span><span class=na>toString</span><span class=o>(</span><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Runtime</span><span class=o>.</span><span class=na>getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=s>&#34;uname -a&#34;</span><span class=o>).</span><span class=na>getInputStream</span><span class=o>())</span>
</span></span></code></pre></div><p><figure><picture><img class="image_figure image_internal" src=https://www.pmnh.site/images/2022-writeup-spring-el-waf/final_payload_result.png alt="Final Payload" loading=lazy decoding=async width=2317 height=896></picture></figure></p><p>I'm not going to supply the payload in text form because I don't want someone blindly copy-pasting into a context where it likely won't work anyway, but hopefully this post gave you the methodology to build your own payload to bypass a WAF and server-side restrictions.</p><h2 id=final-thoughts>Final Thoughts</h2><p>I find WAF bypasses on critical vulnerabilities such as RCE and SQL Injection some of the most fun bugs to work on. Of course the rewards are good, but these sort of bugs really require deep knowledge of <em>why</em> a particular bug works, and the context in which it executes.</p><p>In this case, deep knowledge of Java and SpEL capabilities was required to construct a payload that would both bypass the Akamai WAF as well as work in the context where it was executing.</p><p>I hope you enjoyed this writeup. If you encounter this type of injection and you need help bypassing a WAF, feel free to <a href=https://twitter.com/pmnh_>DM me on Twitter</a> and I'm always happy to collab if you have a confirmed injection but can't escalate it.</p></div><div class=post_comments></div></article><aside class=sidebar><section class=sidebar_inner><br><div class=search><input type=search class="search_field form_field" placeholder=Search... id=find autocomplete=off data-scope=post>
<label for=find class=search_label><svg class="icon"><title>search</title><use xlink:href="#search"/></svg></label><div class="search_results results"></div></div><div class=sidebardisclaimer><h2 class=mt-4>Disclaimer</h2>The opinions expressed on this site are my own personal opinions and do not represent my employerâ€™s view in any way. All content on this site should be used for legal, research purposes only on assets you are permitted to test. The author expressly disclaims any and all liability from misuse of material on this site.</div><h2 class=mt-4>Featured Posts</h2><ul><li><a href=https://www.pmnh.site/post/2022-sep-2-years-bug-bounty/ class=nav-link title="Reflecting on 2 Years of Bug Bounty">Reflecting on 2 Years of Bug Bounty</a></li></ul><h2 class=mt-4>Recent Posts</h2><ul class=flex-column><li><a href=https://www.pmnh.site/post/2022-sep-2-years-bug-bounty/ class=nav-link title="Reflecting on 2 Years of Bug Bounty">Reflecting on 2 Years of Bug Bounty</a></li><li><a href=https://www.pmnh.site/post/ctf-htb-cyber-apolcalypse-web-genesis-wallet/ class=nav-link title="CTF Writeup: 2022 HTB Cyber Apolcalypse Web Challenge: Genesis Wallet">CTF Writeup: 2022 HTB Cyber Apolcalypse Web Challenge: Genesis Wallet</a></li><li><a href=https://www.pmnh.site/post/cve-luxcal-2021/ class=nav-link title="LuxCal 5.1.x and below Authentication Bypass: CVE-2021-45914, CVE-2021-45915">LuxCal 5.1.x and below Authentication Bypass: CVE-2021-45914, CVE-2021-45915</a></li><li><a href=https://www.pmnh.site/post/advanced-sqlmap-case-study-1/ class=nav-link title="Advanced sqlmap Case Study">Advanced sqlmap Case Study</a></li></ul><div><h2 class="mt-4 taxonomy" id=tags-section>Tags</h2><nav class=tags_nav><a href=https://www.pmnh.site/tags/advanced/ class="post_tag button button_translucent" title=advanced>ADVANCED
<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/authentication/ class="post_tag button button_translucent" title=authentication>AUTHENTICATION
<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/bugcrowd/ class="post_tag button button_translucent" title=bugcrowd>BUGCROWD
<span class=button_tally>1</span></a><br><div class="post_tags_toggle button">All Tags</div><div class=post_tags><div class=tags_list><a href=https://www.pmnh.site/tags/advanced/ class="post_tag button button_translucent" data-position=1 title=advanced>ADVANCED<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/authentication/ class="post_tag button button_translucent" data-position=1 title=authentication>AUTHENTICATION<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/bugcrowd/ class="post_tag button button_translucent" data-position=1 title=bugcrowd>BUGCROWD<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/csrf/ class="post_tag button button_translucent" data-position=1 title=csrf>CSRF<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/ctf/ class="post_tag button button_translucent" data-position=1 title=ctf>CTF<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/cve/ class="post_tag button button_translucent" data-position=1 title=cve>CVE<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/index/ class="post_tag button button_translucent" data-position=1 title=index>INDEX<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/learning/ class="post_tag button button_translucent" data-position=1 title=learning>LEARNING<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/nodejs/ class="post_tag button button_translucent" data-position=1 title=nodejs>NODEJS<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/rce/ class="post_tag button button_translucent" data-position=1 title=rce>RCE<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/sqli/ class="post_tag button button_translucent" data-position=1 title=sqli>SQLI<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/sqlmap/ class="post_tag button button_translucent" data-position=1 title=sqlmap>SQLMAP<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/varnish/ class="post_tag button button_translucent" data-position=1 title=varnish>VARNISH<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/waf/ class="post_tag button button_translucent" data-position=1 title=waf>WAF<span class=button_tally>1</span></a>
<a href=https://www.pmnh.site/tags/writeup/ class="post_tag button button_translucent" data-position=1 title=writeup>WRITEUP<span class=button_tally>1</span></a><div class=tags_sort><span title="sort alphabetically">[A~Z]</span><span title="sort by count">[0~9]</span></div><span class=tags_hide><svg class="icon"><use xlink:href="#closeme"/></svg></span></div></div></nav></div></section></aside></div></main><svg width="0" height="0" class="hidden"><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter"><path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68.0 01-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043.0-1.924.366-2.643 1.078A3.56 3.56.0 008.766 5.383c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846.0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47.0.929.273 1.705.82 2.388a3.623 3.623.0 002.115 1.291c-.312.08-.641.118-.979.118-.312.0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652.0 002.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422.0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139.0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77.0 001.172-4.892v-.468a7.788 7.788.0 001.84-1.921 8.142 8.142.0 01-2.11.593z"/></symbol><symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar"><path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916.0 1e2v352c0 33.084 26.916 60 60 60h392c33.084.0 60-26.916 60-60V1e2c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028.0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028.0 20 8.972 20 20v48z"/><path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github"><path d="M255.968 5.329C114.624 5.329.0 120.401.0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384.0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008.0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992.0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584.0 34.368-.32 62.08-.32 70.496.0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab"><path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6.0L12.3 74.8z"/><path d="M12.3 74.7.5 111c-1 3.2.0 6.8 3 8.8l101.6 74-92.5-119z"/><path d="M105 193.7l-38.6-119h-54l92.7 119z"/><path d="M105 193.7l38.7-119H66.4l38.7 119z"/><path d="M105 193.7l38.7-119H198l-93 119z"/><path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/><path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6.0L198 74.8z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss"><circle cx="3.429" cy="20.571" r="3.429"/><path d="M11.429 24h4.57C15.999 15.179 8.821 8.001.0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"/><path d="M24 24C24 10.766 13.234.0.0.0v4.571c10.714.0 19.43 8.714 19.43 19.429z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h362c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top"><path d="M604.501 440.509 325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298.0 36.323s26.223 10.024 36.222.0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221.0 9.999-10.023 9.999-26.298.0-36.323z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly"><path d="M504.971 239.029 448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c19.851.0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002.0 004e2 320v108c0 19.851-16.149 36-36 36h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c46.318.0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568.0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255.0 24-10.745 24-24S205.255.0 192 0h-44c-46.318.0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568.0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255.0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851.0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002.0 00112 192z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy"><path d="M23 2.75A2.75 2.75.0 0020.25.0H8.75A2.75 2.75.0 006 2.75v13.5A2.75 2.75.0 008.75 19h11.5A2.75 2.75.0 0023 16.25zM18.25 14.5h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5z"/><path d="M8.75 20.5A4.255 4.255.0 014.5 16.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752.0 001 5.25v16A2.752 2.752.0 003.75 24h12a2.752 2.752.0 002.75-2.75v-.75z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme"><path d="M284.286 256.002 506.143 34.144c7.811-7.811 7.811-20.475.0-28.285-7.811-7.81-20.475-7.811-28.285.0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285.0-7.81 7.811-7.811 20.475.0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475.0 28.285a19.938 19.938.0 0014.143 5.857 19.94 19.94.0 0014.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475.0-28.285L284.286 256.002z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu"><path d="M492 236H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954.0 96s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram"><path d="M12 2.163c3.204.0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849.0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204.0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849.0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741.0 8.333.014 7.053.072c-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.668.072 4.948c.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24s3.668-.014 4.948-.072c4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403.0-6.162 2.759-6.162 6.162S8.597 18.163 12 18.163s6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zM12 16c-2.209.0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796.0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795.0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="youtube"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23.0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23.0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.549-4.385-8.816zM9 16V8l8 3.993L9 16z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow"><path d="M21 27v-8h3v11H0V19h3v8h18z"/><path d="M17.1.2 15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8 13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></symbol></svg><footer class=footer><div class="footer_inner wrap pale"><img src=https://www.pmnh.site/icons/apple-touch-icon.png class="icon icon_2 transparent" alt="A developer's notes in the world of security research and bug bounty, by pmnh"><p>Copyright&nbsp;<span class=year></span>&nbsp;A DEVELOPER'S NOTES IN THE WORLD OF SECURITY RESEARCH AND BUG BOUNTY, BY PMNH. All Rights Reserved</p><a class=to_top href=#documentTop><svg class="icon"><title>to-top</title><use xlink:href="#to-top"/></svg></a></div></footer><script type=text/javascript src=https://www.pmnh.site/en/js/bundle.19668860ea177cfe8cad686c7464b57e39acde1a4c33f6a1a8c57f7ab127ac39e8330b38e7184422cf0e9351ef3efaf75d122eca818d38a929941b8a5c04b09e.js integrity="sha512-GWaIYOoXfP6MrWhsdGS1fjms3hpMM/ahqMV/erEnrDnoMws45xhEIs8Ok1HvPvr3XRIuyoGNOKkplBuKXASwng==" crossorigin=anonymous></script>
<script src=https://www.pmnh.site/js/search.min.8a7989a3155833e5032fb922caab1294cb74fa70ec9dd2d720a230b8405586447e2e017e6eff69c3d91da71078850ced1543f1cb71d2822e4faab818381c4f1e.js></script></body></html>